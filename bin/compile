#!/usr/bin/env bash
#Build docker image needed for compiling haxe source in Javascript
echo "Installing haxelibs and compiling haxe->javascript"
set -e
ROOTPATH="`dirname \"$0\"`"/../

COMPOSE_TOOLS="docker-compose -f docker-compose.tools.yml run"

pushd $ROOTPATH
# Delete all prior builds
rm -rf build
# Recreate the build folders. This SHOULD be done automatically
# in the haxe build process, but there is a weird interaction with
# docker, and I often see errors such as:
#   Unix.Unix_error(Unix.EBUSY, "mkdir", "build/local-scaling-server")
# so a workaround is to create all the directories before building.
# This is annoying and fragile, but no other solution was found.
mkdir -p build/server
mkdir -p build/local-scaling-server
mkdir -p build/test

path_to_haxe=$(which haxe || true)
if [ -x "$path_to_haxe" ] && [ "$TRAVIS" != "1" ] ; then
	echo "haxe is available! $path_to_haxe"
	haxe etc/hxml/build-all.hxml
else
	$COMPOSE_TOOLS compile
fi

popd

echo "Finished compiling"